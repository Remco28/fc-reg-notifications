# Task Specification: Web UI for Registration Monitoring

**Date:** 2025-09-30
**Author:** Architect
**Status:** Ready for Implementation

## Objective

Build a simple web UI that displays fencing tournament registrations stored in the database. The UI should provide an at-a-glance view of all tracked registrations with filtering and sorting capabilities.

## User Story

As a fencing club administrator, I want to view all tournament registrations in a web browser so that I can quickly see who has registered for upcoming tournaments without querying the database directly.

## Scope

### In Scope
- Read-only web interface displaying registrations
- List view showing fencer name, tournament name, events, and last seen timestamp
- Basic filtering by tournament and fencer name
- Sorting by date and fencer name
- Responsive design that works on desktop and mobile
- Integration with existing FastAPI application

### Out of Scope
- User authentication/authorization (future milestone)
- Registration editing or deletion via UI
- Real-time updates (polling/WebSocket)
- Multi-club support
- Export functionality (CSV/Excel)
- Advanced analytics or dashboards

## Technical Approach

### Architecture Decision
Use server-side rendered HTML with FastAPI templates (Jinja2) rather than a separate SPA framework. This keeps the stack simple, maintains consistency with the existing Python codebase, and avoids adding JavaScript build complexity.

### Technology Stack
- **Backend:** FastAPI (existing)
- **Templating:** Jinja2
- **CSS Framework:** Simple, modern CSS (consider Pico CSS or MVP.css for minimal styling without build steps)
- **JavaScript:** Minimal vanilla JS for client-side filtering/sorting enhancements (optional)

## Implementation Requirements

### 1. Dependencies
Add to `requirements.txt`:
```
jinja2
```

### 2. Template Structure
Create new directory and files:
- `app/templates/` (new directory)
  - `base.html` - Base template with common layout elements
  - `registrations.html` - Main registrations list view
  - `partials/` (subdirectory)
    - `registration_row.html` - Reusable registration row template

### 3. API Endpoints
Modify/create in `app/api/endpoints.py`:

#### `GET /`
- **Purpose:** Main UI landing page showing all registrations
- **Query Parameters:**
  - `tournament` (optional): Filter by tournament name (case-insensitive substring match)
  - `fencer` (optional): Filter by fencer name (case-insensitive substring match)
  - `sort_by` (optional): Sort field (`fencer_name`, `tournament_name`, `last_seen_at`). Default: `last_seen_at` descending
  - `sort_order` (optional): `asc` or `desc`. Default: `desc`
- **Response:** Rendered HTML page
- **Database Query:** Join `Registration`, `Fencer`, and `Tournament` tables to retrieve all data needed for display
- **Error Handling:** Return 500 page with friendly error message if database connection fails

#### `GET /registrations/json` (API endpoint)
- **Purpose:** JSON API for programmatic access (supports future API clients)
- **Query Parameters:** Same as `GET /` above
- **Response:** JSON array of registration objects
- **Schema:**
  ```json
  [
    {
      "id": 1,
      "fencer_name": "John Doe",
      "tournament_name": "Spring Championship 2025",
      "tournament_date": "2025-03-15",
      "events": "Men's Epee, Men's Foil",
      "last_seen_at": "2025-09-29T18:30:00Z"
    }
  ]
  ```

### 4. Service Layer
Create new file: `app/services/registration_query_service.py`

#### Function: `query_registrations`
```python
def query_registrations(
    db: Session,
    tournament_filter: Optional[str] = None,
    fencer_filter: Optional[str] = None,
    sort_by: str = "last_seen_at",
    sort_order: str = "desc"
) -> List[Dict[str, Any]]
```

**Responsibilities:**
- Execute SQLAlchemy query joining Registration, Fencer, and Tournament
- Apply filters using `ilike` for case-insensitive substring matching
- Apply sorting based on parameters
- Return list of dictionaries with flattened registration data
- Handle invalid sort fields by falling back to default

**Expected Behavior:**
- Empty filters return all registrations
- Invalid `sort_by` value defaults to `last_seen_at`
- Invalid `sort_order` value defaults to `desc`

### 5. HTML Templates

#### `base.html`
- Standard HTML5 boilerplate
- Include CSS framework via CDN (recommend Pico CSS: `<link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">`)
- Navigation header with app title
- Content block for child templates
- Footer with minimal attribution

#### `registrations.html`
- Extends `base.html`
- Filter form with inputs for tournament and fencer name (GET form submission)
- Table displaying registrations with columns:
  - Fencer Name
  - Tournament Name
  - Tournament Date
  - Events
  - Last Seen At (formatted as relative time, e.g., "2 hours ago")
- Empty state message when no registrations match filters
- Sorting controls (clickable column headers or dropdown)

### 6. Styling Guidelines
- Use semantic HTML5 elements
- Mobile-first responsive design
- Ensure WCAG 2.1 AA accessibility (proper heading hierarchy, alt text, ARIA labels where needed)
- Table should be scrollable on mobile if necessary
- Form inputs should have clear labels and placeholders

### 7. Configuration
No new environment variables required. Use existing database session management from `app/database.py`.

### 8. Integration Points
- Mount template directory in `app/main.py` using `Jinja2Templates`:
  ```python
  from fastapi.templating import Jinja2Templates
  templates = Jinja2Templates(directory="app/templates")
  ```
- Import and include router from `app/api/endpoints.py` if using APIRouter pattern
- Existing `/health` endpoint should remain unchanged

## Acceptance Criteria

### Functional Requirements
1. [ ] `GET /` endpoint renders HTML page showing all registrations
2. [ ] Registrations display fencer name, tournament name, tournament date, events, and last seen timestamp
3. [ ] Filter form allows filtering by tournament name (case-insensitive, partial match)
4. [ ] Filter form allows filtering by fencer name (case-insensitive, partial match)
5. [ ] Column sorting works for fencer name, tournament name, and last seen date
6. [ ] Empty state displays helpful message when no registrations exist or match filters
7. [ ] `GET /registrations/json` returns valid JSON array matching documentation schema

### Non-Functional Requirements
8. [ ] Page loads in under 2 seconds with 100 registrations
9. [ ] UI is responsive and usable on mobile devices (tested at 375px width)
10. [ ] No JavaScript errors in browser console
11. [ ] HTML validates with no critical accessibility issues (test with browser dev tools)

### Code Quality
12. [ ] All database queries use existing CRUD patterns or new service functions
13. [ ] No business logic in route handlers (delegate to service layer)
14. [ ] Templates use Jinja2 best practices (template inheritance, macros for repeated elements)
15. [ ] Code follows existing project conventions (imports, naming, docstrings)

## Testing Guidance

### Manual Testing
1. Start the application: `uvicorn app.main:app --reload`
2. Seed the database with test data using the existing `scrape` CLI command
3. Navigate to `http://localhost:8000/` in a browser
4. Verify all acceptance criteria above
5. Test filter combinations and sorting
6. Test JSON endpoint using curl or browser: `curl http://localhost:8000/registrations/json`

### Automated Testing (Optional but Recommended)
- Write integration tests for `query_registrations` service function
- Write route tests using FastAPI TestClient to verify endpoint responses
- Test filter and sort logic with various parameter combinations

## Constraints & Considerations

### Performance
- Query should include appropriate SQLAlchemy joins (not N+1 queries)
- Consider adding database indexes if registration count grows beyond 10k records (future optimization)

### Security
- All query parameters should be validated (avoid SQL injection via SQLAlchemy parameterized queries)
- No sensitive data in registrations (names and tournaments are public information)

### Future Enhancements
- Add pagination when registration count exceeds 100
- Implement search with autocomplete
- Add "subscribe to tournament" functionality
- Include registration trend charts

## Related Files
- Models: `app/models.py` (no changes expected)
- CRUD: `app/crud.py` (no changes expected)
- Main application: `app/main.py` (template configuration needed)
- Existing endpoints: `app/api/endpoints.py` (currently empty, will add routes here)
- Architecture doc: `docs/ARCHITECTURE.md` (update after implementation with new endpoints)

## Questions for Implementer
None expected. Specification is complete. If clarification is needed, consult the Architect via the User.

## Revision History
- 2025-09-30: Initial specification created